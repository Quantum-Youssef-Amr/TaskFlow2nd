<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project - TaskFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="container mt-5 pt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 id="projectTitle" class="text-white fw-bold">Loading...</h1>
            <div>
                <button class="btn btn-accent me-2" data-bs-toggle="modal" data-bs-target="#taskModal">+ Add
                    Task</button>
                <button id="deleteProjectBtn" class="btn btn-danger" style="display:none;"
                    onclick="deleteProject()">Delete Project</button>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="kanban-col shadow-lg">
                    <h5 class="text-accent mb-3">To Do</h5>
                    <div id="todoColumn" data-status="todo" class="tasks min-vh-50"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="kanban-col shadow-lg">
                    <h5 class="text-warning mb-3">In Progress</h5>
                    <div id="inProgressColumn" data-status="in-progress" class="tasks min-vh-50"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="kanban-col shadow-lg">
                    <h5 class="text-success mb-3">Done</h5>
                    <div id="doneColumn" data-status="done" class="tasks min-vh-50"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="taskModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Add New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="taskTitle" class="form-control form-control-lg mb-3" placeholder="Task Title"
                        required>
                    <textarea id="taskDesc" class="form-control mb-3" rows="3" placeholder="Description"></textarea>

                    <div class="mb-3">
                        <label class="form-label text-accent fw-bold">Assign To</label>
                        <select id="taskAssignee" class="form-select form-select-lg" required>
                            <option value="">Select team member...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-accent fw-bold">Priority</label>
                        <select id="taskPriority" class="form-select form-select-lg">
                            <option value="low">Low Priority</option>
                            <option value="medium">Medium Priority</option>
                            <option value="high">High Priority</option>
                            <option value="critical">Critical Priority</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-accent fw-bold">Due Date</label>
                        <input type="date" id="taskDue" class="form-control form-control-lg">
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-accent fw-bold">Attach Files</label>
                        <input type="file" id="taskFiles" class="form-control" multiple>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="saveTaskBtn" class="btn btn-accent px-5">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold">Edit Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="editTaskTitle" class="form-control form-control-lg mb-3">
                    <textarea id="editTaskDesc" class="form-control mb-3" rows="3"></textarea>
                    <select id="editTaskAssignee" class="form-select mb-3"></select>
                    <select id="editTaskPriority" class="form-select mb-3">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                    <input type="date" id="editTaskDue" class="form-control mb-3">
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="saveEditTaskBtn" class="btn btn-accent px-5">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal fade" id="taskDetailModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between border-0">
                    <h5 id="detailTitle" class="fw-bold"></h5>
                    <div>
                        <button id="editTaskBtn" class="btn btn-warning btn-sm me-2" style="display:none;">Edit</button>
                        <button id="deleteTaskBtn" class="btn btn-danger btn-sm" style="display:none;"
                            onclick="deleteTask()">Delete</button>
                    </div>
                </div>
                <div class="modal-body">
                    <p><strong>Description:</strong> <span id="detailDesc" class="text-light"></span></p>
                    <p><strong>Assignee:</strong> <span id="detailAssignee" class="text-accent"></span> |
                        <strong>Priority:</strong> <span id="detailPriority" class="text-warning"></span> |
                        <strong>Due:</strong> <span id="detailDue" class="text-info"></span>
                    </p>
                    <p><strong>Status:</strong>
                        <select id="detailStatus" class="form-select w-auto d-inline ms-2">
                            <option value="todo">To Do</option>
                            <option value="in-progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                    </p>
                    <hr class="border-secondary">
                    <h6>Attached Files</h6>
                    <ul id="fileList" class="list-group mb-3"></ul>
                    <hr class="border-secondary">
                    <h6>Comments</h6>
                    <ul id="commentList" class="list-group mb-3"></ul>
                    <div class="input-group">
                        <input type="text" id="newComment" class="form-control" placeholder="Write a comment...">
                        <input type="file" id="commentFile" class="form-control">
                        <button class="btn btn-accent" onclick="addComment()">Post</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        // Upload file to backend and return URL
        async function uploadFileToServer(file) {
            if (!file) return null;
            const fd = new FormData();
            fd.append('file', file, file.name);
            const res = await fetch('http://localhost:5000/api/upload', { method: 'POST', body: fd });
            const data = await res.json();
            return (data && data.success) ? { name: data.name || file.name, data: data.url } : null;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const projectId = parseInt(urlParams.get('id'));
        const teamId = localStorage.getItem('teamId');
        const currentUserRole = localStorage.getItem('role');
        const currentUserName = localStorage.getItem('user');

        // Show project title (coerce id types to avoid mismatches from DB strings)
        const project = window.projects.find(p => Number(p.id) === projectId);
        if (project) {
            document.getElementById('projectTitle').textContent = project.name;
        }

        // Show delete button only for manager
        if (currentUserRole === 'manager') {
            const delBtn = document.getElementById('deleteProjectBtn');
            if (delBtn) delBtn.style.display = 'inline-block';
        }

        const columns = {
            todo: document.getElementById('todoColumn'),
            'in-progress': document.getElementById('inProgressColumn'),
            done: document.getElementById('doneColumn')
        };

        let currentTask = null;

        // Populate assignee dropdowns
        function populateAssigneeDropdowns() {
            const selects = [document.getElementById('taskAssignee'), document.getElementById('editTaskAssignee')];
            const members = (window.appUsers || []).filter(u => String(u.team_id) === String(teamId));
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Select team member...</option>';
                members.forEach(user => {
                    const opt = document.createElement('option');
                    opt.value = user.name || user.email || user.id || '';
                    opt.textContent = user.name || user.email || (`User ${user.id || ''}`);
                    select.appendChild(opt);
                });
            });
        }

        function renderTasks() {
            Object.values(columns).forEach(col => col.innerHTML = '');
            const teamTasks = window.tasks.filter(t => Number(t.projectId) === projectId && String(t.team_id) === String(teamId));
            if (teamTasks.length === 0) {
                columns.todo.innerHTML = '<p class="text-muted text-center py-5">No tasks yet</p>';
                return;
            }
            teamTasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'task-card mb-3 p-3 rounded shadow-sm border border-secondary';
                card.draggable = true;
                card.dataset.id = task.id;
                card.innerHTML = `
          <h6 class="mb-1 text-white fw-bold">${task.title}</h6>
          <small class="text-muted">${task.assignee || 'Unassigned'} â€¢ Due: ${task.due || 'No date'}</small>
          <div class="mt-2">
            <span class="badge priority-${task.priority || 'low'} me-2">${(task.priority || 'low').toUpperCase()}</span>
            <span class="badge status-${task.status || 'todo'}">${(task.status || 'todo').replace('-', ' ')}</span>
          </div>
        `;
                card.onclick = e => { e.stopPropagation(); openTaskDetail(task); };
                const statusKey = (task.status === 'in-progress') ? 'in-progress' : (task.status || 'todo');
                (columns[statusKey] || columns.todo).appendChild(card);
            });
            setupDragDrop();
        }

        function setupDragDrop() {
            document.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('id', card.dataset.id);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
            });
            Object.values(columns).forEach(col => {
                col.addEventListener('dragover', e => e.preventDefault());
                col.addEventListener('drop', async e => {
                    e.preventDefault();
                    const id = e.dataTransfer.getData('id');
                    const task = window.tasks.find(t => t.id == id);
                    if (!task) return;
                    task.status = col.dataset.status || 'todo';
                    try { localStorage.setItem('tasks', JSON.stringify(window.tasks || [])); } catch { }
                    await syncData();
                    renderTasks();
                });
            });
        }

        // Save new task
        document.getElementById('saveTaskBtn').addEventListener('click', async () => {
            const title = document.getElementById('taskTitle').value.trim();
            const assignee = document.getElementById('taskAssignee').value;
            if (!title || !assignee) return alert('Task title and assignee required');
            const newTask = {
                id: null,
                projectId,
                title,
                description: document.getElementById('taskDesc').value,
                assignee,
                priority: document.getElementById('taskPriority').value,
                due: document.getElementById('taskDue').value,
                status: 'todo',
                team_id: teamId,
                comments: [],
                files: []
            };
            const files = Array.from(document.getElementById('taskFiles').files || []);
            if (files.length) {
                const uploaded = await Promise.all(files.map(f => uploadFileToServer(f)));
                newTask.files = uploaded.filter(Boolean).map(u => ({ name: u.name, data: u.url || u.data }));
            }
            window.tasks.push(newTask);
            try { localStorage.setItem('tasks', JSON.stringify(window.tasks || [])); } catch { }
            await syncData();
            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            renderTasks();
        });

        // Task detail modal
        window.openTaskDetail = (task) => {
            currentTask = task;
            document.getElementById('detailTitle').textContent = task.title;
            document.getElementById('detailDesc').textContent = task.description || 'No description';
            document.getElementById('detailAssignee').textContent = task.assignee || 'Unassigned';
            document.getElementById('detailPriority').textContent = (task.priority || 'low').toUpperCase();
            document.getElementById('detailDue').textContent = task.due || 'No due date';
            document.getElementById('detailStatus').value = task.status;

            // Show edit/delete only for manager
            const isManager = currentUserRole === 'manager';
            document.getElementById('editTaskBtn').style.display = isManager ? 'inline-block' : 'none';
            document.getElementById('deleteTaskBtn').style.display = isManager ? 'inline-block' : 'none';

            // Files
            document.getElementById('fileList').innerHTML = Array.isArray(task.files) && task.files.length > 0
                ? task.files.map(f => `<li class="list-group-item"><a href="${f.data || f.url}" download="${f.name}" class="file-link">${f.name}</a></li>`).join('')
                : '<li class="list-group-item text-muted">No files attached</li>';

            // Comments
            document.getElementById('commentList').innerHTML = Array.isArray(task.comments) && task.comments.length > 0
                ? task.comments.map(c => `<li class="list-group-item"><strong>${c.user}:</strong> ${c.text || ''} ${c.file ? `<a href="${c.file.data || c.file.url}" download="${c.file.name}" class="file-link">[${c.file.name}]</a>` : ''}</li>`).join('')
                : '<li class="list-group-item text-muted">No comments yet</li>';

            new bootstrap.Modal(document.getElementById('taskDetailModal')).show();
        };

        // Edit task
        document.getElementById('editTaskBtn').addEventListener('click', () => {
            document.getElementById('editTaskTitle').value = currentTask.title;
            document.getElementById('editTaskDesc').value = currentTask.description || '';
            document.getElementById('editTaskAssignee').value = currentTask.assignee;
            document.getElementById('editTaskPriority').value = currentTask.priority;
            document.getElementById('editTaskDue').value = currentTask.due;
            bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
            new bootstrap.Modal(document.getElementById('editTaskModal')).show();
        });
        document.getElementById('saveEditTaskBtn').addEventListener('click', async () => {
            let taskRef = window.tasks.find(t => String(t.id) === String(currentTask.id)) || currentTask;
            taskRef.title = document.getElementById('editTaskTitle').value.trim();
            taskRef.description = document.getElementById('editTaskDesc').value;
            taskRef.assignee = document.getElementById('editTaskAssignee').value;
            taskRef.priority = document.getElementById('editTaskPriority').value;
            taskRef.due = document.getElementById('editTaskDue').value;
            try { localStorage.setItem('tasks', JSON.stringify(window.tasks || [])); } catch { }
            await syncData();
            bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
            renderTasks();
        });

        // Delete task
        window.deleteTask = async () => {
            if (!currentTask || !confirm('Delete this task permanently?')) return;
            window.tasks = window.tasks.filter(t => t.id !== currentTask.id);
            await syncData();
            // After sync, reload canonical data from backend
            await syncData();
            bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
            renderTasks();
        };

        // Delete project
        window.deleteProject = async (id) => {
            const resolvedId = id ?? projectId;
            if (!resolvedId) return;
            if (!confirm('Delete this project and all its tasks?')) return;
            window.projects = window.projects.filter(p => String(p.id) !== String(resolvedId));
            window.tasks = window.tasks.filter(t => String(t.projectId) !== String(resolvedId));
            await syncData();
            // After sync, reload canonical data from backend
            await syncData();
            location.href = 'projects.html';
        };

        // Status change
        document.getElementById('detailStatus').addEventListener('change', async (e) => {
            if (!currentTask) return;
            currentTask.status = e.target.value;
            try { localStorage.setItem('tasks', JSON.stringify(window.tasks || [])); } catch { }
            await syncData();
            renderTasks();
        });

        // Add comment
        window.addComment = async () => {
            const text = document.getElementById('newComment').value.trim();
            const fileInput = document.getElementById('commentFile');
            const file = fileInput.files[0];
            if (!text && !file) return;
            const comment = { user: currentUserName, text, time: new Date().toLocaleString(), file: null };
            if (file) {
                const uploaded = await uploadFileToServer(file);
                if (uploaded) comment.file = { name: uploaded.name || file.name, data: uploaded.url || uploaded.data };
            }
            let taskRef = window.tasks.find(t => String(t.id) === String(currentTask.id)) || currentTask;
            if (!taskRef.comments) taskRef.comments = [];
            taskRef.comments.push(comment);
            currentTask = taskRef;
            try { localStorage.setItem('tasks', JSON.stringify(window.tasks || [])); } catch { }
            const listEl = document.getElementById('commentList');
            const newCommentHtml = `<li class="list-group-item"><strong>${comment.user}:</strong> ${comment.text || ''} ${comment.file ? `<a href="${comment.file.data}" download="${comment.file.name}" class="file-link">[${comment.file.name}]</a>` : ''}</li>`;
            if (listEl && listEl.children.length && listEl.children[0].classList.contains('text-muted')) {
                listEl.innerHTML = newCommentHtml;
            } else {
                listEl.insertAdjacentHTML('beforeend', newCommentHtml);
            }
            document.getElementById('newComment').value = '';
            fileInput.value = '';
            await syncData();
        };

        // Initialize
        populateAssigneeDropdowns();
        renderTasks();
    </script>

    <style>
        .tasks {
            min-height: 100px;
            padding: 8px;
        }

        .task-card.dragging {
            opacity: 0.5;
            background: #333 !important;
        }

        .kanban-col:hover {
            background: #252525 !important;
        }

        .file-link {
            color: #FF0B55;
            text-decoration: underline;
        }

        .file-link:hover {
            color: #fff;
        }
    </style>
</body>

</html>