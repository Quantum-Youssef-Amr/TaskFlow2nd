<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects - TaskFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <div class="container mt-5 pt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Projects</h1>
            <button id="newProjectBtn" class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#projectModal">+
                New Project</button>
        </div>
        <div class="row" id="projectList"></div>
    </div>

    <!-- Create / Edit Project Modal -->
    <div class="modal fade" id="projectModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 id="projectModalTitle">Create Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editProjectId">
                    <input type="text" id="projectName" class="form-control mb-3" placeholder="Project Name" required>
                    <textarea id="projectDesc" class="form-control" placeholder="Description" required></textarea>
                </div>
                <div class="modal-footer">
                    <button id="saveProjectBtn" class="btn btn-accent">Save Project</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
        const list = document.getElementById('projectList');
        const role = localStorage.getItem('role') || 'member';

        // Hide "New Project" button for non-managers
        if (role !== 'manager') {
            document.getElementById('newProjectBtn').style.display = 'none';
        }

        function renderProjects() {
            list.innerHTML = projects.map(p => `
        <div class="col-md-4 mb-4">
          <div class="card h-100 shadow">
            <div class="card-body">
              <h5>${p.name}</h5>
              <p class="text-muted small">${p.description}</p>
              <div class="mt-3">
                <a href="project-detail.html?id=${p.id}" class="btn btn-accent btn-sm me-2">Open</a>
                ${role === 'manager' ? `
                  <button class="btn btn-warning btn-sm me-2" onclick="editProject(${p.id})">Edit</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteProject(${p.id})">Delete</button>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `).join('');
        }

        window.editProject = (id) => {
            const project = projects.find(p => p.id === id);
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectDesc').value = project.description;
            new bootstrap.Modal(document.getElementById('projectModal')).show();
        };

        window.deleteProject = (id) => {
            if (confirm('Delete this project and all its tasks? This cannot be undone.')) {
                projects = projects.filter(p => p.id !== id);
                tasks = tasks.filter(t => t.projectId !== id);
                saveData();
                renderProjects();
            }
        };

        document.getElementById('saveProjectBtn').addEventListener('click', () => {
            const id = document.getElementById('editProjectId').value;
            const name = document.getElementById('projectName').value.trim();
            const desc = document.getElementById('projectDesc').value.trim();

            if (name && desc) {
                if (id) {
                    const p = projects.find(p => p.id == id);
                    p.name = name;
                    p.description = desc;
                } else {
                    projects.push({ id: Date.now(), name, description: desc });
                }
                saveData();
                bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
                renderProjects();
            }
        });

        renderProjects();
    </script>
</body>

</html>